import{V as P,a as K,j as O,L as I,W as q,k as J,S as N,F as Q,D as U,H as X,P as Y,M as G,d as j,G as Z,e as _}from"./ExtendedTriangle-Chm2bbkR.js";import{R as $}from"./RoundedBoxGeometry-BW68IL6j.js";import{G as ee}from"./GLTFLoader-Dl6abS6P.js";import{O as te}from"./OrbitControls-lzJCl7xY.js";import{m as ae}from"./BufferGeometryUtils-Cscy-pCt.js";import{S as oe}from"./stats.min-GTpOrGrX.js";import{g as ie}from"./lil-gui.module.min-Bc0DeA9g.js";import{S as se}from"./StaticGeometryGenerator-8L97b6eW.js";import{M as re}from"./MeshBVH-CPVAl5W3.js";import{M as ne}from"./MeshBVHHelper-jLfel8l5.js";import"./_commonjsHelpers-Cpj98o6Y.js";const a={firstPerson:!1,displayCollider:!1,displayBVH:!1,visualizeDepth:10,gravity:-30,playerSpeed:10,physicsSteps:5,reset:F};let f,d,g,R,b,W,v,c,V,e,r,C=!1,z=!1,B=!1,H=!1,D=!1,h=new P,k=new P(0,1,0),w=new P,E=new P,M=new K,A=new O,y=new I;de();T();function de(){f=new q({antialias:!0}),f.setPixelRatio(window.devicePixelRatio),f.setSize(window.innerWidth,window.innerHeight),f.setClearColor(1251612,1),f.shadowMap.enabled=!0,f.shadowMap.type=J,document.body.appendChild(f.domElement),g=new N,g.fog=new Q(1251612,20,70);const t=new U(16777215,3);t.position.set(1,1.5,1).multiplyScalar(50),t.shadow.mapSize.setScalar(2048),t.shadow.bias=-1e-4,t.shadow.normalBias=.05,t.castShadow=!0;const i=t.shadow.camera;i.bottom=i.left=-30,i.top=30,i.right=45,g.add(t),g.add(new X(16777215,2241348,.4)),d=new Y(75,window.innerWidth/window.innerHeight,.1,50),d.position.set(10,10,-10),d.far=100,d.updateProjectionMatrix(),window.camera=d,R=new _,r=new te(d,f.domElement),W=new oe,document.body.appendChild(W.dom),le(),e=new G(new $(1,2,1,10,.5),new j),e.geometry.translate(0,-.5,0),e.capsuleInfo={radius:.5,segment:new I(new P,new P(0,-1,0))},e.castShadow=!0,e.receiveShadow=!0,e.material.shadowSide=2,g.add(e),F(),b=new ie,b.add(a,"firstPerson").onChange(n=>{n||d.position.sub(r.target).normalize().multiplyScalar(10).add(r.target)});const p=b.addFolder("Visualization");p.add(a,"displayCollider"),p.add(a,"displayBVH"),p.add(a,"visualizeDepth",1,20,1).onChange(n=>{V.depth=n,V.update()}),p.open();const s=b.addFolder("Player");s.add(a,"physicsSteps",0,30,1),s.add(a,"gravity",-100,100,.01).onChange(n=>{a.gravity=parseFloat(n)}),s.add(a,"playerSpeed",1,20),s.open(),b.add(a,"reset"),b.open(),window.addEventListener("resize",function(){d.aspect=window.innerWidth/window.innerHeight,d.updateProjectionMatrix(),f.setSize(window.innerWidth,window.innerHeight)},!1),window.addEventListener("keydown",function(n){switch(n.code){case"KeyW":z=!0;break;case"KeyS":B=!0;break;case"KeyD":D=!0;break;case"KeyA":H=!0;break;case"Space":C&&(h.y=10,C=!1);break}}),window.addEventListener("keyup",function(n){switch(n.code){case"KeyW":z=!1;break;case"KeyS":B=!1;break;case"KeyD":D=!1;break;case"KeyA":H=!1;break}})}function le(){new ee().load("https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/dungeon-warkarma/scene.gltf",l=>{const t=l.scene;t.scale.setScalar(.01);const i=new K;i.setFromObject(t),i.getCenter(t.position).negate(),t.updateMatrixWorld(!0);const p={};t.traverse(o=>{if(!(/Boss/.test(o.name)||/Enemie/.test(o.name)||/Shield/.test(o.name)||/Sword/.test(o.name)||/Character/.test(o.name)||/Gate/.test(o.name)||/Cube/.test(o.name)||o.material&&o.material.color.r===1)&&o.isMesh){const S=o.material.color.getHex();p[S]=p[S]||[],p[S].push(o)}}),v=new Z;for(const o in p){const S=p[o],x=[];if(S.forEach(u=>{if(u.material.emissive.r!==0)v.attach(u);else{const m=u.geometry.clone();m.applyMatrix4(u.matrixWorld),x.push(m)}}),x.length){const u=ae(x),m=new G(u,new j({color:parseInt(o),shadowSide:2}));m.castShadow=!0,m.receiveShadow=!0,m.material.shadowSide=2,v.add(m)}}const s=new se(v);s.attributes=["position"];const n=s.generate();n.boundsTree=new re(n),c=new G(n),c.material.wireframe=!0,c.material.opacity=.5,c.material.transparent=!0,V=new ne(c,a.visualizeDepth),g.add(V),g.add(c),g.add(v)})}function F(){h.set(0,0,0),e.position.set(15.75,-3,30),d.position.sub(r.target),r.target.copy(e.position),d.position.add(e.position),r.update()}function pe(l){C?h.y=l*a.gravity:h.y+=l*a.gravity,e.position.addScaledVector(h,l);const t=r.getAzimuthalAngle();z&&(w.set(0,0,-1).applyAxisAngle(k,t),e.position.addScaledVector(w,a.playerSpeed*l)),B&&(w.set(0,0,1).applyAxisAngle(k,t),e.position.addScaledVector(w,a.playerSpeed*l)),H&&(w.set(-1,0,0).applyAxisAngle(k,t),e.position.addScaledVector(w,a.playerSpeed*l)),D&&(w.set(1,0,0).applyAxisAngle(k,t),e.position.addScaledVector(w,a.playerSpeed*l)),e.updateMatrixWorld();const i=e.capsuleInfo;M.makeEmpty(),A.copy(c.matrixWorld).invert(),y.copy(i.segment),y.start.applyMatrix4(e.matrixWorld).applyMatrix4(A),y.end.applyMatrix4(e.matrixWorld).applyMatrix4(A),M.expandByPoint(y.start),M.expandByPoint(y.end),M.min.addScalar(-i.radius),M.max.addScalar(i.radius),c.geometry.boundsTree.shapecast({intersectsBounds:o=>o.intersectsBox(M),intersectsTriangle:o=>{const S=w,x=E,u=o.closestPointToSegment(y,S,x);if(u<i.radius){const m=i.radius-u,L=x.sub(S).normalize();y.start.addScaledVector(L,m),y.end.addScaledVector(L,m)}}});const p=w;p.copy(y.start).applyMatrix4(c.matrixWorld);const s=E;s.subVectors(p,e.position),C=s.y>Math.abs(l*h.y*.25);const n=Math.max(0,s.length()-1e-5);s.normalize().multiplyScalar(n),e.position.add(s),C?h.set(0,0,0):(s.normalize(),h.addScaledVector(s,-s.dot(h))),d.position.sub(r.target),r.target.copy(e.position),d.position.add(e.position),e.position.y<-25&&F()}function T(){W.update(),requestAnimationFrame(T);const l=Math.min(R.getDelta(),.1);if(a.firstPerson?(r.maxPolarAngle=Math.PI,r.minDistance=1e-4,r.maxDistance=1e-4):(r.maxPolarAngle=Math.PI/2,r.minDistance=1,r.maxDistance=20),c){c.visible=a.displayCollider,V.visible=a.displayBVH;const t=a.physicsSteps;for(let i=0;i<t;i++)pe(l/t)}r.update(),f.render(g,d)}
