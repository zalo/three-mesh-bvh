import{C as $,ad as J,ae as K,f as k,af as A,M as W,u as Q,R as E,W as ee,S as te,P as ne,ag as se,ah as re,c as O,b as oe,j as ae}from"./ExtendedTriangle-Chm2bbkR.js";import{S as ie}from"./Stats-9dH8FB2H.js";import{O as ce}from"./OrbitControls-lzJCl7xY.js";import{g as le}from"./lil-gui.module.min-Bc0DeA9g.js";import{M as ue}from"./MeshBVHHelper-jLfel8l5.js";import{C as Y,A as de,S as pe,N as q,I as me}from"./MeshBVH-CPVAl5W3.js";import{a as he,c as fe,d as ge}from"./ExtensionUtilities-D80Yg0dh.js";const g=new $;class ye extends J{constructor(l){super(l),this.propertyNameMapping={},this.customPropertyMapping={}}load(l,P,T,x){const h=this,p=new K(this.manager);p.setPath(this.path),p.setResponseType("arraybuffer"),p.setRequestHeader(this.requestHeader),p.setWithCredentials(this.withCredentials),p.load(l,function(u){try{P(h.parse(u))}catch(v){x?x(v):console.error(v),h.manager.itemError(l)}},T,x)}setPropertyNameMapping(l){this.propertyNameMapping=l}setCustomPropertyNameMapping(l){this.customPropertyMapping=l}parse(l){function P(e,r=0){const n=/^ply([\s\S]*)end_header(\r\n|\r|\n)/;let t="";const s=n.exec(e);s!==null&&(t=s[1]);const o={comments:[],elements:[],headerLength:r,objInfo:""},i=t.split(/\r\n|\r|\n/);let a;function w(d,m){const c={type:d[0]};return c.type==="list"?(c.name=d[3],c.countType=d[1],c.itemType=d[2]):c.name=d[1],c.name in m&&(c.name=m[c.name]),c}for(let d=0;d<i.length;d++){let m=i[d];if(m=m.trim(),m==="")continue;const c=m.split(/\s+/),G=c.shift();switch(m=c.join(" "),G){case"format":o.format=c[0],o.version=c[1];break;case"comment":o.comments.push(m);break;case"element":a!==void 0&&o.elements.push(a),a={},a.name=c[0],a.count=parseInt(c[1]),a.properties=[];break;case"property":a.properties.push(w(c,H.propertyNameMapping));break;case"obj_info":o.objInfo=m;break;default:console.log("unhandled",G,c)}}return a!==void 0&&o.elements.push(a),o}function T(e,r){switch(r){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function x(e,r){const n={};for(let t=0;t<e.length;t++){if(r.empty())return null;if(e[t].type==="list"){const s=[],o=T(r.next(),e[t].countType);for(let i=0;i<o;i++){if(r.empty())return null;s.push(T(r.next(),e[t].itemType))}n[e[t].name]=s}else n[e[t].name]=T(r.next(),e[t].type)}return n}function h(){const e={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[],faceVertexColors:[]};for(const r of Object.keys(H.customPropertyMapping))e[r]=[];return e}function p(e){const r=e.map(t=>t.name);function n(t){for(let s=0,o=t.length;s<o;s++){const i=t[s];if(r.includes(i))return i}return null}return{attrX:n(["x","px","posx"])||"x",attrY:n(["y","py","posy"])||"y",attrZ:n(["z","pz","posz"])||"z",attrNX:n(["nx","normalx"]),attrNY:n(["ny","normaly"]),attrNZ:n(["nz","normalz"]),attrS:n(["s","u","texture_u","tx"]),attrT:n(["t","v","texture_v","ty"]),attrR:n(["red","diffuse_red","r","diffuse_r"]),attrG:n(["green","diffuse_green","g","diffuse_g"]),attrB:n(["blue","diffuse_blue","b","diffuse_b"])}}function u(e,r){const n=h(),t=/end_header\s+(\S[\s\S]*\S|\S)\s*$/;let s,o;(o=t.exec(e))!==null?s=o[1].split(/\s+/):s=[];const i=new xe(s);e:for(let a=0;a<r.elements.length;a++){const w=r.elements[a],d=p(w.properties);for(let m=0;m<w.count;m++){const c=x(w.properties,i);if(!c)break e;f(n,w.name,c,d)}}return v(n)}function v(e){let r=new k;e.indices.length>0&&r.setIndex(e.indices),r.setAttribute("position",new A(e.vertices,3)),e.normals.length>0&&r.setAttribute("normal",new A(e.normals,3)),e.uvs.length>0&&r.setAttribute("uv",new A(e.uvs,2)),e.colors.length>0&&r.setAttribute("color",new A(e.colors,3)),(e.faceVertexUvs.length>0||e.faceVertexColors.length>0)&&(r=r.toNonIndexed(),e.faceVertexUvs.length>0&&r.setAttribute("uv",new A(e.faceVertexUvs,2)),e.faceVertexColors.length>0&&r.setAttribute("color",new A(e.faceVertexColors,3)));for(const n of Object.keys(H.customPropertyMapping))e[n].length>0&&r.setAttribute(n,new A(e[n],H.customPropertyMapping[n].length));return r.computeBoundingSphere(),r}function f(e,r,n,t){if(r==="vertex"){e.vertices.push(n[t.attrX],n[t.attrY],n[t.attrZ]),t.attrNX!==null&&t.attrNY!==null&&t.attrNZ!==null&&e.normals.push(n[t.attrNX],n[t.attrNY],n[t.attrNZ]),t.attrS!==null&&t.attrT!==null&&e.uvs.push(n[t.attrS],n[t.attrT]),t.attrR!==null&&t.attrG!==null&&t.attrB!==null&&(g.setRGB(n[t.attrR]/255,n[t.attrG]/255,n[t.attrB]/255).convertSRGBToLinear(),e.colors.push(g.r,g.g,g.b));for(const s of Object.keys(H.customPropertyMapping))for(const o of H.customPropertyMapping[s])e[s].push(n[o])}else if(r==="face"){const s=n.vertex_indices||n.vertex_index,o=n.texcoord;s.length===3?(e.indices.push(s[0],s[1],s[2]),o&&o.length===6&&(e.faceVertexUvs.push(o[0],o[1]),e.faceVertexUvs.push(o[2],o[3]),e.faceVertexUvs.push(o[4],o[5]))):s.length===4&&(e.indices.push(s[0],s[1],s[3]),e.indices.push(s[1],s[2],s[3])),t.attrR!==null&&t.attrG!==null&&t.attrB!==null&&(g.setRGB(n[t.attrR]/255,n[t.attrG]/255,n[t.attrB]/255).convertSRGBToLinear(),e.faceVertexColors.push(g.r,g.g,g.b),e.faceVertexColors.push(g.r,g.g,g.b),e.faceVertexColors.push(g.r,g.g,g.b))}}function z(e,r){const n={};let t=0;for(let s=0;s<r.length;s++){const o=r[s],i=o.valueReader;if(o.type==="list"){const a=[],w=o.countReader.read(e+t);t+=o.countReader.size;for(let d=0;d<w;d++)a.push(i.read(e+t)),t+=i.size;n[o.name]=a}else n[o.name]=i.read(e+t),t+=i.size}return[n,t]}function R(e,r,n){function t(s,o,i){switch(o){case"int8":case"char":return{read:a=>s.getInt8(a),size:1};case"uint8":case"uchar":return{read:a=>s.getUint8(a),size:1};case"int16":case"short":return{read:a=>s.getInt16(a,i),size:2};case"uint16":case"ushort":return{read:a=>s.getUint16(a,i),size:2};case"int32":case"int":return{read:a=>s.getInt32(a,i),size:4};case"uint32":case"uint":return{read:a=>s.getUint32(a,i),size:4};case"float32":case"float":return{read:a=>s.getFloat32(a,i),size:4};case"float64":case"double":return{read:a=>s.getFloat64(a,i),size:8}}}for(let s=0,o=e.length;s<o;s++){const i=e[s];i.type==="list"?(i.countReader=t(r,i.countType,n),i.valueReader=t(r,i.itemType,n)):i.valueReader=t(r,i.type,n)}}function U(e,r){const n=h(),t=r.format==="binary_little_endian",s=new DataView(e,r.headerLength);let o,i=0;for(let a=0;a<r.elements.length;a++){const w=r.elements[a],d=w.properties,m=p(d);R(d,s,t);for(let c=0;c<w.count;c++){o=z(i,d),i+=o[1];const G=o[0];f(n,w.name,G,m)}}return v(n)}function I(e){let r=0,n=!0,t="";const s=[],o=new TextDecoder().decode(e.subarray(0,5)),i=/^ply\r\n/.test(o);do{const a=String.fromCharCode(e[r++]);a!==`
`&&a!=="\r"?t+=a:(t==="end_header"&&(n=!1),t!==""&&(s.push(t),t=""))}while(n&&r<e.length);return i===!0&&r++,{headerText:s.join("\r")+"\r",headerLength:r}}let N;const H=this;if(l instanceof ArrayBuffer){const e=new Uint8Array(l),{headerText:r,headerLength:n}=I(e),t=P(r,n);if(t.format==="ascii"){const s=new TextDecoder().decode(e);N=u(s,t)}else N=U(l,t)}else N=u(l,P(l));return N}}class xe{constructor(l){this.arr=l,this.i=0}empty(){return this.i>=this.arr.length}next(){return this.arr[this.i++]}}W.prototype.raycast=he;k.prototype.computeBoundsTree=fe;k.prototype.disposeBoundsTree=ge;let F,_,B,b,C,M,L,X,D=new Q,S;const we="https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/point-cloud-porsche/scene.ply",V=new E,y={displayHelper:!1,helperDepth:10,displayParents:!1,strategy:Y,pointSize:.005,raycastThreshold:.005,useBVH:!0};function Te(){X=document.getElementById("output"),b=new ee({antialias:!0}),b.setPixelRatio(window.devicePixelRatio),b.setSize(window.innerWidth,window.innerHeight),b.setClearColor(1251612,1),document.body.appendChild(b.domElement),_=new te,B=new ne(75,window.innerWidth/window.innerHeight,.1,50),B.position.set(3,3,3),B.far=100,B.updateProjectionMatrix(),new ce(B,b.domElement),F=new ie,document.body.appendChild(F.dom),window.addEventListener("resize",function(){B.aspect=window.innerWidth/window.innerHeight,B.updateProjectionMatrix(),b.setSize(window.innerWidth,window.innerHeight)},!1),new ye().load(we,u=>{u.center();const v=new se({size:y.pointSize,vertexColors:!0});L=new re(u,v),L.matrixAutoUpdate=!1,_.add(L);const f=[],z=u.clone();let R=z.attributes.position.count;for(let I=0,N=R;I<N;I++)f.push(I,I,I);z.setIndex(f);const U=new O({color:16711680});C=new W(z,U),console.time("computeBoundsTree"),C.geometry.computeBoundsTree({mode:y.mode}),console.timeEnd("computeBoundsTree"),M=new ue(C,y.depth),_.add(M)});const P=new oe(.01,32,32),T=new O({color:16776960,opacity:.9,transparent:!0});S=new W(P,T),S.visible=!1,_.add(S);const x=new le,h=x.addFolder("helper");h.add(y,"displayHelper"),h.add(y,"displayParents").onChange(u=>{M.displayParents=u,M.update()}),h.add(y,"helperDepth",1,20,1).name("depth").onChange(u=>{M.depth=parseInt(u),M.update()}),h.open();const p=x.addFolder("points");p.add(y,"useBVH"),p.add(y,"strategy",{CENTER:Y,AVERAGE:de,SAH:pe}).onChange(u=>{console.time("computeBoundsTree"),C.geometry.computeBoundsTree({strategy:parseInt(u)}),console.timeEnd("computeBoundsTree"),M.update()}),p.add(y,"pointSize",.001,.01,.001),p.add(y,"raycastThreshold",.001,.01,.001),p.open()}window.addEventListener("pointermove",j=>{if(!C)return;D.x=j.clientX/window.innerWidth*2-1,D.y=-(j.clientY/window.innerHeight)*2+1,V.setFromCamera(D,B);const l=window.performance.now();if(y.useBVH){S.visible=!1;const T=new ae;T.copy(C.matrixWorld).invert(),V.ray.applyMatrix4(T);const h=V.params.Points.threshold/((C.scale.x+C.scale.y+C.scale.z)/3),p=h*h,{ray:u}=V;let v=1/0;C.geometry.boundsTree.shapecast({boundsTraverseOrder:f=>f.distanceToPoint(u.origin),intersectsBounds:(f,z,R)=>R>v?q:(f.expandByScalar(h),u.intersectsBox(f)?me:q),intersectsTriangle:f=>{if(u.distanceSqToPoint(f.a)<p){const R=u.origin.distanceTo(f.a);R<v&&(v=R,S.position.copy(f.a).applyMatrix4(C.matrixWorld),S.visible=!0)}}})}else{const x=V.intersectObject(L,!0)[0];x?(S.position.copy(x.point),S.visible=!0):S.visible=!1}const P=window.performance.now()-l;X.innerText=`${P.toFixed(2)}ms`},!1);function Z(){requestAnimationFrame(Z),L&&(L.material.size=y.pointSize,M.visible=y.displayHelper,V.params.Points.threshold=y.raycastThreshold),F.begin(),b.render(_,B),F.end()}Te();Z();
